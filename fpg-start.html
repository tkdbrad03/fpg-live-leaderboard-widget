<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FPG Scorekeeper - Start Screen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .selected {
      background-color: #3c763d !important;
      color: #fff !important;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

  <div class="mb-6">
    <img 
      src="https://raw.githubusercontent.com/tkdbrad03/fpg-scorekeeper/main/fpg-logo.png"
      alt="FPG Logo"
      class="w-48 mx-auto"
    />
  </div>

  <div class="text-center mb-8">
    <h2 class="text-xl font-bold mb-3 text-gray-800">Will you be keeping score today?</h2>
    <div class="flex justify-center space-x-4">
      <button id="yes-scorekeeper" class="py-2 px-5 bg-green-600 text-white rounded-md hover:bg-green-700">Yes, I'll keep score</button>
      <button id="no-scorekeeper" class="py-2 px-5 bg-gray-400 text-white rounded-md hover:bg-gray-500">No, just playing</button>
    </div>
  </div>

  <div class="w-full max-w-md bg-white shadow-md rounded-lg p-6">
    <label for="course-select" class="block text-gray-700 font-semibold mb-2">Choose Course</label>
    <select id="course-select" class="w-full border border-gray-300 rounded-md p-2 mb-4">
      <option value="">Loading courses...</option>
    </select>

    <label for="group-select" class="block text-gray-700 font-semibold mb-2">Choose Group</label>
    <select id="group-select" class="w-full border border-gray-300 rounded-md p-2">
      <option value="">Select a course first</option>
    </select>
  </div>

  <div class="mt-6 text-center">
    <button 
      id="continue-btn" 
      class="py-2 px-6 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition"
    >
      Continue
    </button>
  </div>

  <div style="text-align:center; padding:2rem 1rem; color:#6b7280; font-size:0.875rem; margin-top:2rem;">
    Powered by CompliTrst™ • <span id="footer-date"></span>
  </div>

  <script>
    const BIN_URL = "https://api.jsonbin.io/v3/b/68f6557dae596e708f1f69d1/latest";

    let courses = [];
    let selectedCourse = null;
    let selectedGroup = null;
    let isScorekeeper = false;

    async function loadCourses() {
      try {
        const cacheBuster = '?v=' + Date.now();
        const res = await fetch(BIN_URL + cacheBuster);
        const data = await res.json();

        console.log('Raw response:', data);

        let coursesArray = data.record;
        
        console.log('After getting record:', coursesArray);
        console.log('Is array?', Array.isArray(coursesArray));
        console.log('Length:', coursesArray?.length);
        
        // Aggressive unwrapping - keep going until we hit actual course objects
        let maxIterations = 10;
        let iterations = 0;
        
        while (iterations < maxIterations && Array.isArray(coursesArray)) {
          iterations++;
          console.log('Iteration', iterations, '- Type:', typeof coursesArray[0], 'Length:', coursesArray.length);
          
          // If we have an array with course objects, we're done
          if (coursesArray.length > 0 && coursesArray[0] && typeof coursesArray[0] === 'object' && coursesArray[0].course_name) {
            console.log('Found courses array!');
            break;
          }
          
          // If single element array, unwrap it
          if (coursesArray.length === 1) {
            coursesArray = coursesArray[0];
          } else {
            // Multiple elements - assume this is the courses array
            break;
          }
        }

        // Final check - if still wrapped, try one more unwrap
        if (Array.isArray(coursesArray) && coursesArray.length === 1 && Array.isArray(coursesArray[0])) {
          coursesArray = coursesArray[0];
        }

        courses = Array.isArray(coursesArray) ? coursesArray : [coursesArray];
        
        console.log('Final courses:', courses);
        console.log('Total courses found:', courses.length);
        
        if (courses.length > 0) {
          console.log('First course:', courses[0]?.course_name);
          console.log('Last course:', courses[courses.length - 1]?.course_name);
        }

        const courseSelect = document.getElementById("course-select");
        
        if (courses.length === 0) {
          courseSelect.innerHTML = '<option value="">No courses found</option>';
          return;
        }

        courseSelect.innerHTML = '<option value="">Select a course</option>';

        courses.forEach((c, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = c.course_name || c.name || 'Unknown Course';
          courseSelect.appendChild(opt);
          console.log('Added course:', opt.textContent);
        });
        
        console.log('Course dropdown populated with', courses.length, 'courses');
      } catch (err) {
        console.error("Error loading courses:", err);
        document.getElementById("course-select").innerHTML = '<option value="">Error: ' + err.message + '</option>';
      }
    }

    document.getElementById("course-select").addEventListener("change", function() {
      const index = this.value;
      const groupSelect = document.getElementById("group-select");
      groupSelect.innerHTML = "";

      if (index === "") {
        groupSelect.innerHTML = '<option value="">Select a course first</option>';
        return;
      }

      selectedCourse = courses[index];
      
      if (selectedCourse.holes && !selectedCourse.course_holes) {
        selectedCourse.course_holes = selectedCourse.holes;
      }
      
      const groups = selectedCourse.groups || [];

      if (groups.length === 0) {
        groupSelect.innerHTML = '<option value="">No groups found for this course</option>';
        return;
      }

      groupSelect.innerHTML = '<option value="">Select a group</option>';
      groups.forEach((g, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = 'Group ' + g.group_number + ' - ' + g.tee_time;
        groupSelect.appendChild(opt);
      });
    });

    document.getElementById("group-select").addEventListener("change", function() {
      const val = this.value;
      selectedGroup = val !== "" ? val : null;
    });

    document.getElementById("yes-scorekeeper").addEventListener("click", function() {
      isScorekeeper = true;
      this.classList.add("selected");
      document.getElementById("no-scorekeeper").classList.remove("selected");
    });

    document.getElementById("no-scorekeeper").addEventListener("click", function() {
      isScorekeeper = false;
      this.classList.add("selected");
      document.getElementById("yes-scorekeeper").classList.remove("selected");
    });

    document.getElementById("continue-btn").addEventListener("click", function() {
      if (!selectedCourse) {
        alert("Please select a course before continuing.");
        return;
      }

      if (selectedGroup === null) {
        alert("Please select your group before continuing.");
        return;
      }

      localStorage.setItem("selectedCourse", JSON.stringify(selectedCourse));
      localStorage.setItem("selectedGroup", selectedGroup);
      localStorage.setItem("isScorekeeper", isScorekeeper);

      window.location.href = "fpg-tracker.html";
    });

    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('footer-date').textContent = now.toLocaleDateString('en-US', options);

    loadCourses();
  </script>
</body>
</html>
